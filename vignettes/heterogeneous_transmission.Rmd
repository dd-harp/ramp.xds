---
title: "Heterogeneous Transmission"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Heterogeneous Transmission}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


Heterogeneous transmission includes several closely related concepts:

+ **[Heterogeneous Biting](heterogeneous_biting.html)** describes differences among population strata in the average rate of exposure. In effect, heterogeneous biting is a kind of *frailty.* In **`ramp.xds`,** heterogeneous biting is implemented through *blood feeding search weights.*

+ **[Environmental Heterogeneity](environmental_heterogeneity.html)** describes the distribution of the expected number of bites in otherwise homogeneous populations strata; if the expected number of bites is *Gamma* distributed, then the number of bites, per person, would have a negative binomial distribution. Environmental heterogeneity is implemented in `Exposure` through a function `F_foi` or `F_ar` that converts the daily entomological inoculation rate into a daily force of infection  under some probabilistic model for the distribution of the expectation. 

+ **[Heterogeneous Mixing](heterogeneous_mixing.html)** describes departures in a model from the idealized *mass-action* assumption for two-species mixing. The algorithms in `ramp.xds` compute the mixing matrix, $\beta$ integrates information about time spent, mosquito daily activity patterns, the sizes of various population strata, search weights, other vertebrate hosts, and visitors. 

+ Temporal variability in mosquito populations driven by exogenous factors, such as weather and vector control,  that modify *potential transmission* by mosquito populations, including **seasonality** and long-term trends. 

## Blood Feeding 

Blood feeding by mosquitoes plays a core role in transmission. In simple models, the blood feeding parameters are often treated as being a result of some innate biological constraints on mosquito species. In **`ramp.xds`,** blood feeding is 
motivated by *searching for resources* and 
handled by a rigid but configurable interface that guarantees mathematical consistency.  
Blood feeding is thus an interaction among humans and mosquitoes. This interface computes:

+ The overall blood feeding rate, (*e.g.* the parameter $f$);

+ The human fraction (*e.g.* the parameter $q$);  

+ The availability of humans / hosts or other vertebrates for mosquitoes searching for blood; 

+ The mixing matrix, $\beta$;  

Parasite transmission is spatially heterogeneous because mosquito populations have preferences for resources whose availability is spatially heterogeneous. Available resources can be modified, in part, because human behaviors are heterogeneous. Heterogeneous blood feeding and transmission is an important aspect of malaria transmission dynamics and control, and it has been implemented in `ramp.xds` through several related concepts and constructs. 

+ *Mosquito populations* are heterogeneous over space and time. Spatial dynamics in `ramp.xds` are organized around the concept of a *patch.* The adult mosquito populations in each *state* are assumed to be homogeneously distributed within each patch.

+ *Human populations:* and human behaviors are heterogeneous in ways that affect exposure and transmission. The design of `ramp.xds` makes it possible to *sub-divide* the human population into an arbitrary number of homogeneous strata. 

+ *Blood feeding* is an interaction between mosquitoes and humans that gives rise to parasite transmission. The design of `ramp.xds` has a new model for blood feeding that incorporates various kinds of heterogeneous transmission. 



## Environmental Heterogeneity 

In mechanistic models of malaria, the hazard rate for exposure is generally assumed to be a linear function of the entomological inoculation rate. In the following, we assume that the number of bites per person over a day (or over some longer interval, $\tau$), is a random variable, and we formulate approximating models for attack rates and hazard rates. 

#### Poisson Hazard Rates

We let $E$ denote the EIR, the expected number of bites per person over a day. If we assume that the distribution of the daily EIR is Poisson, and if a fraction $b$ of infective bites cause an infection, then the relationship between the between EIR and the FoI is a Poisson compounded with a binomial, which is also Poisson: 

$$
Z \sim F_E(z) = \mbox{Poisson}(z, \mbox{mu} = bE(t))
$$

Over a day, the daily attack rate, $\alpha$, is the fraction of individuals who received at least one infection, or: 

$$
\begin{array}{rl}
\alpha &= 1-F_E(0) \\ &= 1-\mbox{Poisson}(0, \mbox{mu} = bE(t)) \\ 
&= 1- e^{-bE(t)} \\
\end{array}
$$

The daily FoI, $h$, is given by a generic formula: 

$$
\alpha = 1 - e^{-h} \mbox{ or equivalently } h = -\ln (1-\alpha)
$$

In this case, the relationship between the FoI and the EIR is:

$$
   h(t) = b E(t)
$$

It is highly mathematically convenient that the relationship is invariant with respect to the sampling period.  

#### Negative Binomial Daily Hazards 

If we assume the number of infective bites, per person, per day, has a Gamma distribution in a population, then we could model the number of infective bites as a Gamma - Poisson mixture process, or a negative binomial distribution. Under this model, the counts for bites by sporozoite positive mosquitoes over one day, $Z$, would be a negative binomial random variable with mean $E$:

$$
Z \sim F_E(z) = \mbox{NB}(z, \mbox{mu} = bE(t), \mbox{size} = 1/\phi)
$$

Assuming an infectious bite causes an infection with probability $b$, the daily attack rate is: 

$$
\begin{array}{rl}
\alpha &= 1-F_E(0) \\ &= 1-\mbox{NB}(0, \mbox{mu} = b E(t), \mbox{size} = 1/\phi) \\
 &= 1- \left(1+b E(t)\phi \right)^{-1/\phi}
\end{array}
$$

This is consistent with a formula that has a continuous daily FoI: 

$$
    h = \frac{\ln \left(1 + bE(t)\phi \right)} {\phi}
$$

## Heterogeneous Biting


**Heterogeneous Biting** is defined throughout the `ramp.xds` implementation and documentation as a difference in the relative biting rates for two strata that are otherwise identical. The implementation relies on two concepts:

+ **blood feeding search weights** or $\left\{\omega\right\}$ describe multiplicative differences among population strata in their availability to blood feeding mosquitoes

+ **relative biting rates** or  $\left\{\xi\right\}$

To be more rigorous, let $E$ denote the *average* daily entomological inoculation rate (dEIR) for a population with multiple strata, and $\xi_i$ the frailty term, then the dEIR for the $i^{th}$ stratum is: 
$$E_i = \xi_i E.$$

The implementation is part of a coherent model for blood feeding that serves at the interface between models of parasite/pathogen infections in humans (*i.e.* $\cal X$), and models of parasite infections in mosquitoes (*i.e.* $\cal YZ$). In this vignette, we introduce the *concept* of heterogeneous biting and its implementation in the blood feeding model using **blood feeding search weights.**


### Blood Feeding Search Weights 

A flexible implementation is handled through the blood feeding model, which includes the the concepts of *blood feeding search weights* and *availability*. The search weights, $\left\{\omega\right\}$, are a measure of how easy it is for mosquitoes to find and blood feed on a host. 

We let $H_i$ denote the size of the $i^{th}$ population, where $$H = \sum_i H_i.$$ The total *availability* of humans for blood feeding is:

$$W = \sum_i \omega_i H_i.$$
Availability is used to compute the overall blood feeding rate for mosquitoes and the human fraction (human blood meals as a fraction of all blood meals). If we assign a biting weight to a stratum, then the fraction of bites received by that stratum is: 

$$ \frac{\omega_i H_i}W.$$ 
**Example 1:** For example, suppose that there are 200 people with a biting weight of 2.25 and 800 people with a biting weight of 1. In this model, the first stratum would get 36% of the total bites:

```{r}
2.25*200/(2.25*(200) + 1*(800))
```

### Relative Biting Rates 

The relative biting rates are defined at the top. 

The relative biting rates are constrained such that 
$$\sum_i \xi_i \frac{H_i}H = 1$$ 

**Example 2:**

For example, if 20% of the population gets bitten at a rate that is 80% higher than the population average, then the other 80% must get bitten (on average) at a rate that is 80% of the population average.

```{r}
1.8*0.2+ 0.8*0.8
```

Relative biting rates are computed automatically from the blood feeding search weights, $\left\{\omega\right\},$ where 

$$\xi_i = \omega_i\frac{H}{W}.$$


**Example 3** computes the search weights from the biting weights

```{r}
searchWts = c(2.25, 1)
Hi = c(200, 800)
H = sum(Hi) 
W = sum(searchWts*Hi)
xi = searchWts*H/W
xi 
```

```{r}
sum(xi*Hi)/H
```


## Heterogeneous Mixing

Heterogeneous blood feeding is a basic feature of malaria transmission (see [Heterogeneous Transmission](heterogeneous_transmission.html). In `exDE,` the term **heterogeneous biting** is used to describe departures from the ideal assumption of *mass-action,* a topic explored by Perkins TA, *et al.* (2013)^[Perkins TA, Scott TW, Le Menach A, Smith DL (2013). Heterogeneity, mixing, and the spatial scales of mosquito-borne pathogen transmission. PLoS Comput Biol 9: e1003327, https://doi.org/10.1371/journal.pcbi.1003540].
. Other departures from being *well-mixed* fall under the category of *heterogeneous mixing.* Computation of the mixing matrix, $\beta$, is described in detail by Wu SL, *et al.*, (2023)^[Wu SL, Henry JM, Citron DT, *et al.* (2023). Spatial dynamics of malaria transmission. PLoS Comput Biol 19: e1010684, https://doi.org/10.1371/journal.pcbi.1010684].
