---
title: "SIS Dynamics (for Humans / Hosts)"
subtitle: "Generalized SIS (Susceptible-Infected-Susceptible) Dynamics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SIS Dynamics (for Humans / Hosts)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

For the **XH** component, the SIS (Susceptible-Infected-Susceptible) model implements a basic system of differential equations. It is, perhaps, the simplest model for an endemic pathogen of humans.

# Dynamics

Here we present the **SIS** model progressively: 

+ **Basic Dynamics** - we present the SIS dynamics as a compartment model 

+ **Generalization** - we add terms for human demography and mass treatment

+ **Implementation** - Finally, we describe the model implemetation in an extensible form 

## Basic Dynamics 

A population is subdivided into susceptible ($S$) and infected and infectious ($I$) individuals, where the total population is $H = S+I.$ 

+ We let $h$ denote the force of infection (FoI). 


+ We let $r$ denote the clearance rate for infections. 

$$
\begin{array}{rl}
\dot{I} &= h S  - rI  \\
\dot{S} &= - \dot I \\
\end{array}
$$
Without demographic change, the SIS model can be rewritten as a single equation: 

$$
\dot{I} = h (H-I) - rI
$$

In addition, we assume that:

+ Infected humans are not fully infectious. The fraction of bloodmeals on infectious humans that infect a mosquito is $c.$ The infective density is $X=cI$ 

+ The probability a human would *test positive* is q, so while true prevalence is $x=I/H,$ the expected value for observed prevalence would be $qI/H.$

## Generalization 

The implementation of the model is general and extensible. It includes:

+ The population birth rate is $B(t, H)$ 

+ Deaths occur at a constant per-capita rate $\mu$ 

+ There is no parameter to describe disease-induced mortality 

+ The implementation includes a port to model mass treatment. In this model, humans who are treated and cured, at the rate $\xi(t)$ become susceptible to infection.
    

The generalized system of equations is implemented as:  

$$
\begin{array}{rl}
\dot{H} &= B(t, H) - \mu H \\
\dot{I} &= h (H-I)  - \left(r+\xi\left(t\right)\right) I - \mu I 
\end{array}
$$

Utilities in `ramp.demog` make it possible to simulate aging and dynamic strata. We let $D$ denote a matrix and implement the dynamics in a more general form: 

$$
\begin{array}{rl}
\dot{H} &= B(t, H) - D \cdot H \\
\dot{I} &= h (H-I)  - \left(r+\xi\left(t\right)\right) I - D \cdot I 
\end{array}
$$
Where the these two models are equivalent if $\mbox{diag} D = \mu.$ 

## Implementation 

Even in this simplified form, we are assuming that a population could be stratified, such that the variables, terms,  and parameter are all vectors with length `nStrata.`

The equations are implemented in a generalized and extensible form, where $D$ is a matrix that includes mortality and that could also include dynamic exchanges among strata, including processes such as aging and migration. The derivatives computed by `dXHdt.SIS` are: 

$$
\begin{array}{rl}
\dot{H} &= B(t, H) - D \cdot H \\
\dot{I} &= h (H-I)  - \left(r+\xi\left(t\right)\right) I - D \cdot I 
\end{array}
$$
The parameters are: 


+ $b$ the probability an infective bite on a human causes an infection (used by `Exposure`)

+ $h = F_b(h, E)$ is a dynamical term computed in `Exposure`  

    - By default, the FoI is linearly proportional to the EIR: $h = b \times EIR$ 
    
    - For advanced options, see [Exposure](Exposure.html]) 


+ $r$ the clearance rate


+ $c$ the probability a human bloodmeal infects the mosquito 

+ $\xi(t)$: a function 

    - The function $\xi(t)$ returns $0$ by default.
    
    - The function $\xi(t)$ can be configured as an advanced option using `ramp.control` (see [`ramp.control`::Mass Treatment](https://dd-harp.github.io/ramp.control/articles/MassTreatment.html))

+ $B(t,H)$: a function describing the population birth rate,

    - The function $B(t, H)$ returns $0$ by default.
    
    - Other functions can be configured as advanced options in `ramp.demog` 

+ $D$: a matrix describing demographic changes in the population not associated with disease dynamics, including aging 

    - The $D$ returns the $0$ matrix by default.
    
    - Other matrices can be configured as advanced options in `ramp.demog` 


Infectiousness is computed as:

$$
F_I = c I
$$

# Equilibrium Solutions

A typical situation when using this model is that $H$ (total population size by strata) and $X$ (number of infectious persons by strata) are known from census and survey data. Then it is of interest to find the value of $EIR$ (Entomological Inoculation Rate) which leads to that prevalence at equilibrium.

$$
0 = h \cdot (H-I) - rI 
$$

$$ 
\bar I = H \frac{h}{h+r}
$$

$$
\bar S =  H - \bar I
$$

# Example

```{r, message=FALSE, warning=FALSE}
library(ramp.xds)
library(deSolve)
library(viridisLite)
```


```{r, echo=FALSE} 
#devtools::load_all()
```

Here we run a simple example with 3 population strata at equilibrium. We use `ramp.xds::make_parameters_X_SIS_xde` to
set up parameters. Please note that this only runs the human population component and that most users should read [our fully worked example](ex_534.html) to run a full simulation.

We use the null (constant) model of human demography ($H$ constant for all time).

## The Long Way

To set up systems of differential equations, we must set the values of all our parameters. 


```{r}
nStrata <- 3
H <- c(100, 500, 250)
residence <- rep(1,3) 
nPatches=1
nHabitats=1
membership=1
params <- make_xds_object_template("ode", "eir", nPatches, membership, residence)
```


```{r}
b <- rep(0.55, nStrata) 
c <- rep(0.15, nStrata) 
r <- rep(1/200, nStrata) 
Xo = list(b=b, c=c, r=r)
params <- setup_XH_obj("SIS", params, 1, Xo)
params <- setup_XH_inits(params, H, 1, Xo)
```


```{r}
foi = c(1:3)/365 
eir <- foi/b 
steady_state_X(foi, H, params)-> ss
ss

MYo = list(MYm = eir*H)
```
```{r}
Xo$S=ss$S
Xo$I=ss$I
```


```{r}
params <- setup_MY_obj("trivial", params, 1)
params <- setup_L_obj("trivial", params, 1)
params <- setup_L_inits(params, 1)
params <- make_indices(params)
```

```{r}
F_s = function(t){0*t+1}
F_t= function(t){0*t+1}
F_a = function(a){0*a+1}
F_k = function(a){0*a+1}
```

```{r}
params$EIR_obj = list() 
params$EIR_obj$eir <- as.vector(eir)
params$EIR_obj$scale <- 1 
params$EIR_obj$F_season <- F_s
params$EIR_obj$F_trend  <- F_t
params$EIR_obj$F_age    <- F_a
params$EIR_obj$F_shock  <- F_k
```

```{r}
params = make_indices(params)
```

```{r}
Xo$S=H 
Xo$I=H*0
params = setup_XH_inits(params, H, 1, options = Xo)
y0 <- get_inits(params)
y0$X
```



```{r}
params <- xds_solve(params) 
```


```{r, out.width = "100%"}
clrs = turbo(5)
XH <- get_XH_out(params, 1)

with(XH,{
  plot(time, true_pr[,1], col = clrs[1], ylim = c(0,1), type = "l")
  lines(time, true_pr[,2], col = clrs[2])
  lines(time, true_pr[,3], col =clrs[5])
})  
```


## Using Setup

We have developed utilities for setting up models. We pass the parameter values and initial values as lists: 

```{r}
xds_setup_eir(eir, Xname="SIS", HPop=H, XHoptions = Xo) -> test_SIS_xde
```

```{r}
xds_solve(test_SIS_xde)-> test_SIS_xde 
get_XH_out(test_SIS_xde, 1) -> XH2
sum((XH$true_pr-XH2$true_pr)^2)
```

